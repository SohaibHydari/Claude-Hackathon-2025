<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fridge Roulette</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">

    <!-- External stylesheet -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

    <h1>Fridge Roulette</h1>
    <div class="subtitle">
        Upload your fridge chaos ‚Äî we‚Äôll work the magic ‚ú®
    </div>

    <!-- Upload / Dropzone -->
    <div class="dropzone"
         onclick="document.getElementById('fileInput').click()"
         ondragover="event.preventDefault()"
         ondrop="handleDrop(event)">
        <div class="dropzone-icon">ü•ò</div>
        <div>Drag & drop an image here, or click to upload</div>
        <input type="file" id="fileInput" accept="image/*" onchange="handleFile(this)">
    </div>

    <p id="status"></p>

    <!-- Results container -->
    <div id="results" class="results" style="display:none;"></div>

    <script>
        let selectedFile = null;

        function handleFile(input) {
            selectedFile = input.files[0];
            analyze();
        }

        function handleDrop(event) {
            event.preventDefault();
            selectedFile = event.dataTransfer.files[0];
            analyze();
        }

        function analyze() {
            if (!selectedFile) {
                alert("Please choose an image first.");
                return;
            }

            const status = document.getElementById("status");
            const resultsDiv = document.getElementById("results");

            status.innerHTML = `
                <div class="loading-spinner">ü•ò</div>
                <div>Analyzing your fridge‚Ä¶</div>
            `;

            resultsDiv.style.display = "none";
            resultsDiv.innerHTML = "";

            const formData = new FormData();
            formData.append("image", selectedFile);

            fetch("/analyze", {
                method: "POST",
                body: formData
            })
                .then(response => {
                    // If backend returns non-200, still try to parse JSON error
                    return response.json().then(data => {
                        if (!response.ok) {
                            throw new Error(data.error || "Server error");
                        }
                        return data;
                    });
                })
                .then(data => {
                    status.textContent = "";

                    const ingredients = data.ingredients || [];
                    const recipes = data.recipes || [];
                    const stretchRecipes = data.stretch_recipes || [];

                    // BUILD THE NEW LAYOUT
                    let html = `
                    <div class="results-grid">

                        <!-- LEFT: INGREDIENT PILL BOX -->
                        <div class="ingredients-box">
                            <h2>üçÖ Ingredients Found</h2>
                            <div class="ingredient-list">
                    `;

                    if (ingredients.length === 0) {
                        html += `<div class="empty-text">We couldn't confidently detect ingredients from this photo.</div>`;
                    } else {
                        ingredients.forEach(i => {
                            html += `<div class="ingredient-pill">${i}</div>`;
                        });
                    }

                    html += `
                            </div>
                        </div>

                        <!-- RIGHT: MAIN CONTENT (recipes + stretch ideas) -->
                        <div class="main-right">
                    `;

                    // === RECIPES YOU CAN MAKE NOW ===
                    html += `
                        <div class="recipes-section">
                            <h2>üçΩÔ∏è Recipes You Can Make Now</h2>
                            <div class="recipe-grid">
                    `;

                    if (recipes.length === 0) {
                        html += `<div class="empty-text">No full recipes could be generated from these ingredients.</div>`;
                    } else {
                        recipes.forEach(r => {
                            html += `
                                <div class="recipe-card">
                                    <h3>${r.title}</h3>
                                    <p><em>${r.short_description}</em></p>

                                    <strong>Ingredients from your fridge:</strong>
                                    <ul>
                                        ${(r.ingredients_used || []).map(x => `<li>${x}</li>`).join("")}
                                    </ul>

                                    <strong>Steps:</strong>
                                    <ol>
                                        ${(r.steps || []).map(s => `<li>${s}</li>`).join("")}
                                    </ol>
                                </div>
                            `;
                        });
                    }

                    html += `
                            </div> <!-- .recipe-grid -->
                        </div> <!-- .recipes-section -->
                    `;

                    // === UPGRADE IDEAS SECTION (stretch_recipes) ===
                    if (stretchRecipes.length > 0) {
                        html += `
                            <div class="stretch-section">
                                <h2>‚ú® Upgrade Ideas (Grab a Few Items)</h2>
                                <p class="stretch-subtitle">
                                    Pick up 1‚Äì3 extra ingredients from the store to unlock these dishes:
                                </p>
                                <div class="stretch-grid">
                        `;

                        stretchRecipes.forEach(r => {
                            html += `
                                <div class="stretch-card">
                                    <h3>${r.title}</h3>
                                    <p><em>${r.short_description}</em></p>

                                    <strong>Uses from your fridge:</strong>
                                    <ul>
                                        ${(r.ingredients_used_from_fridge || [])
                                            .map(x => `<li>${x}</li>`)
                                            .join("")}
                                    </ul>

                                    <strong>Buy at the store:</strong>
                                    <ul>
                                        ${(r.extra_ingredients_to_buy || [])
                                            .map(x => `<li>${x}</li>`)
                                            .join("")}
                                    </ul>

                                    <strong>Steps:</strong>
                                    <ol>
                                        ${(r.steps || [])
                                            .map(s => `<li>${s}</li>`)
                                            .join("")}
                                    </ol>
                                </div>
                            `;
                        });

                        html += `
                                </div> <!-- .stretch-grid -->
                            </div> <!-- .stretch-section -->
                        `;
                    }

                    // Close main-right + results-grid
                    html += `
                        </div> <!-- .main-right -->
                    </div> <!-- .results-grid -->
                    `;

                    resultsDiv.innerHTML = html;
                    resultsDiv.style.display = "block";
                })
                .catch(err => {
                    console.error(err);
                    status.textContent = "Error analyzing the image: " + err.message;
                });
        }
    </script>

</body>
</html>
